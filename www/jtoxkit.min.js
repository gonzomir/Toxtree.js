var ccLib={extendArray:function(base,arr){if(base===undefined||base==null)
base=[];else if(!$.isArray(base))
base=[base];if(arr!==undefined&&arr!==null){for(var i=0,al=arr.length;i<al;++i){var v=arr[i];if(base.indexOf(v)<0&&v!==undefined&&v!=null)
base.push(v);}}
return base;},fireCallback:function(callback,self){if(typeof callback!='function')
callback=window[callback];callback.apply((self!==undefined&&self!=null)?self:document,Array.prototype.slice.call(arguments,2));},setObjValue:function(obj,value){if((value===undefined||value===null)&&$(obj).data('default')!==undefined)
value=$(obj).data('default');if(obj.nodeName=="INPUT"||obj.nodeName=="SELECT")
obj.value=value;else if(obj.nodeName=="IMG")
obj.src=value;else if(obj.nodeName=="BUTTON")
$(obj).data('value',value);else
obj.innerHTML=value;},isNull:function(obj){return obj===undefined||obj==null;},isEmpty:function(obj){var empty=true;if(obj!==undefined||obj!=null){if(typeof obj=='object'){for(var i in obj){if(obj[i]!=null){empty=false;break;}}}
else if(typeof obj=='string')
empty=obj.trim().length==0;else if($.isArray(obj))
empty=obj.length==0;else
empty=false;}
return empty;},setJsonValue:function(json,field,val){if(field!==undefined){try{eval("json."+field+" = val");}
catch(e){;}}},getJsonValue:function(json,field){var value=undefined;if(field!==undefined){try{eval("value = json."+field);}
catch(e){;}}
return value;},fillTree:function(root,json,prefix,filter){var self=this;if(!filter)
filter='data-field';var processFn=function(el,json){var value=self.getJsonValue(json,$(el).data('field'));if(value!==undefined){var format=$(el).data('format');if(!!format&&(typeof window[format]=='function')){value=window[format](value,json);}
self.setObjValue(el,value);}}
if($(root).hasClass(filter))
processFn(root,json);$(root.getElementsByClassName(filter)).each(function(i){processFn($(this)[0],json);});if(prefix&&json.id!==undefined){root.id=prefix+json.id;}},clearChildren:function(obj,last){while(obj.lastChild&&obj.lastChild!=last){obj.removeChild(obj.lastChild);}},formatString:function(format){for(var i=1;i<arguments.length;++i){format=format.replace('<'+i+'>',arguments[i]);}
return format;},trim:function(obj){if(obj===undefined||obj==null)
return'';if(typeof obj=="string")
return obj.trim();else
return obj;},copyToClipboard:function(text,prompt){if(!prompt){prompt="Press Ctrl-C (Command-C) to copy and then Enter.";}
window.prompt(prompt,text);},equalizeHeights:function(){var tabs=[];for(var i=0;i<arguments.length;++i){tabs[i]=arguments[i].firstElementChild;}
for(;;){var height=0;for(i=0;i<tabs.length;++i){if(tabs[i]==null)
continue;if(!$(tabs[i]).hasClass('lock-height')&&tabs[i].style.height!='')
tabs[i].style.height="auto";if(tabs[i].offsetHeight>height)
height=tabs[i].offsetHeight;}
if(height==0)
break;for(i=0;i<tabs.length;++i){if(tabs[i]!=null){if(tabs[i].offsetHeight<height)
tabs[i].style.height=height+"px";tabs[i]=tabs[i].nextElementSibling;}}}},addParameter:function(url,param){return url+(url.indexOf('?')>0?"&":"?")+param;},parseURL:function(url){var a=document.createElement('a');a.href=url;return{source:url,protocol:a.protocol.replace(':',''),host:a.hostname,port:a.port,query:a.search,params:(function(){var ret={},seg=a.search.replace(/^\?/,'').split('&'),len=seg.length,i=0,s;for(;i<len;i++){if(!seg[i]){continue;}
s=seg[i].split('=');ret[s[0]]=(s.length>1)?decodeURIComponent(s[1].replace(/\+/g," ")):'';}
return ret;})(),file:(a.pathname.match(/\/([^\/?#]+)$/i)||[,''])[1],hash:a.hash.replace('#',''),path:a.pathname.replace(/^([^\/])/,'/$1'),relative:(a.href.match(/tps?:\/\/[^\/]+(.+)/)||[,''])[1],segments:a.pathname.replace(/^\//,'').split('/')};}};function ccNonEmptyFilter(v){return v!==undefined&&v!=null&&v!='';}
var jToxDataset=(function(){var defaultSettings={"showExport":true,"groups":{"Identifiers":function(name,features){return["http://www.opentox.org/api/1.1#Diagram","http://www.opentox.org/api/1.1#CASRN","http://www.opentox.org/api/1.1#EINECS","http://www.opentox.org/api/1.1#IUCLID5_UUID"];},"Names":function(name,features){return["http://www.opentox.org/api/1.1#ChemicalName","http://www.opentox.org/api/1.1#TradeName","http://www.opentox.org/api/1.1#IUPACName","http://www.opentox.org/api/1.1#SMILES","http://www.opentox.org/api/1.1#InChIKey","http://www.opentox.org/api/1.1#InChI","http://www.opentox.org/api/1.1#REACHRegistrationDate"];},"Calculated":function(name,features){var arr=[];for(var f in features){if(!ccLib.isNull(features[f].source)&&!ccLib.isNull(features[f].source.type)&&!features[f].source.type.toLowerCase()=="algorithm")
arr.push(f);}
return arr;},"Other":function(name,features){var arr=[];for(var f in features){if(!features[f].used)
arr.push(f);}
return arr;}},"exports":[{type:"chemical/x-mdl-sdfile",icon:"images/sdf.jpg"},{type:"chemical/x-cml",icon:"images/cml.jpg"},{type:"chemical/x-daylight-smiles",icon:"images/smi.png"},{type:"chemical/x-inchi",icon:"images/inchi.png"},{type:"text/uri-list",icon:"images/link.png"},{type:"application/pdf",icon:"images/pdf.png"},{type:"text/csv",icon:"images/excel.png"},{type:"text/plain",icon:"images/excel.png"},{type:"text/x-arff",icon:"images/weka.png"},{type:"text/x-arff-3col",icon:"images/weka.png"},{type:"application/rdf+xml",icon:"images/rdf.gif"},{type:"application/json",icon:"images/json.png"}]};var instanceCount=0;var baseFeatures={"http://www.opentox.org/api/1.1#REACHRegistrationDate":{title:"REACH Date",accumulate:"compound.reachdate",used:true},"http://www.opentox.org/api/1.1#CASRN":{title:"CAS",accumulate:"compound.cas",used:true},"http://www.opentox.org/api/1.1#ChemicalName":{title:"Name",accumulate:"compound.name",used:true},"http://www.opentox.org/api/1.1#TradeName":{title:"Trade Name",accumulate:"compound.tradename",used:true},"http://www.opentox.org/api/1.1#IUPACName":{title:"IUPAC Name",accumulate:["compound.name","compound.iupac"],used:true},"http://www.opentox.org/api/1.1#EINECS":{title:"EINECS",accumulate:"compound.einecs",used:true},"http://www.opentox.org/api/1.1#InChI":{title:"InChI",accumulate:"compound.inchi",used:true,shorten:true},"http://www.opentox.org/api/1.1#InChI_std":{title:"InChI",accumulate:"compound.inchi",used:true,shorten:true},"http://www.opentox.org/api/1.1#InChIKey":{title:"InChI Key",accumulate:"compound.inchikey",used:true},"http://www.opentox.org/api/1.1#InChIKey_std":{title:"InChI Key",accumulate:"compound.inchikey",used:true},"http://www.opentox.org/api/1.1#InChI_AuxInfo":{title:"InChI Aux",accumulate:"compound.inchi",used:true},"http://www.opentox.org/api/1.1#InChI_AuxInfo_std":{title:"InChI Aux",accumulate:"compound.inchi",used:true},"http://www.opentox.org/api/1.1#IUCLID5_UUID":{title:"IUCLID5 UUID",accumulate:"compound.i5uuid",used:true,shorten:true},"http://www.opentox.org/api/1.1#SMILES":{title:"SMILES",accumulate:"compound.smiles",used:true,shorten:true},"http://www.opentox.org/api/dblinks#CMS":{title:"CMS",used:true},"http://www.opentox.org/api/dblinks#ChEBI":{title:"ChEBI",used:true},"http://www.opentox.org/api/dblinks#Pubchem":{title:"Public Chem",used:true},"http://www.opentox.org/api/dblinks#ChemSpider":{title:"Chem Spider",used:true},"http://www.opentox.org/api/dblinks#ChEMBL":{title:"ChEMBL",used:true},"http://www.opentox.org/api/dblinks#ToxbankWiki":{title:"Toxban Wiki",used:true},"http://www.opentox.org/api/1.1#Diagram":{title:"Diagram",accumulate:"compound.URI",used:true},};var cls=function(root,settings){var self=this;self.rootElement=root;self.settings=$.extend({},defaultSettings,jToxKit.settings,settings);self.features=null;self.dataset=null;self.groups=null;self.fixTable=self.varTable=null;self.instanceNo=instanceCount++;root.appendChild(jToxKit.getTemplate('#jtox-dataset'));};cls.prototype={prepareTabs:function(root,isMain,nodeFn){var self=this;var fr=document.createDocumentFragment();var all=document.createElement('div');fr.appendChild(all);ulEl=document.createElement('ul');all.appendChild(ulEl);var featNames={};var createATab=function(grId,name){var liEl=document.createElement('li');ulEl.appendChild(liEl);var aEl=document.createElement('a');aEl.href="#"+grId;aEl.innerHTML=name;liEl.appendChild(aEl);return liEl;};for(var gr in self.groups){var grId="jtox-ds-"+gr+"-"+self.instanceNo;createATab(grId,gr.replace(/_/g," "));var divEl=document.createElement('div');divEl.id=grId;for(var i=0,glen=self.groups[gr].length;i<glen;++i){var fId=self.groups[gr][i];if(!ccLib.isNull(self.features[fId].title)){var el=nodeFn(fId,self.features[fId].title);if(!ccLib.isNull(el))
divEl.appendChild(el);self.features[fId].used=true;}}
all.appendChild(divEl);}
if(isMain&&self.settings.showExport){var tabId="jtox-ds-export-"+self.instanceNo;var liEl=createATab(tabId,"Export");$(liEl).addClass('jtox-ds-export');var divEl=jToxKit.getTemplate('#jtox-ds-export')
divEl.id=tabId;all.appendChild(divEl);divEl=divEl.getElementsByClassName('jtox-exportlist')[0];var base=jToxKit.grabBaseUrl(self.datasetUri,"dataset");for(var i=0,elen=self.settings.exports.length;i<elen;++i){var expo=self.settings.exports[i];var el=jToxKit.getTemplate('#jtox-ds-download');divEl.appendChild(el);el.getElementsByTagName('a')[0].href=ccLib.addParameter(self.datasetUri,"media="+expo.type);var img=el.getElementsByTagName('img')[0];img.alt=img.title=expo.type;img.src=base+expo.icon;}}
root.appendChild(fr);return $(all).tabs({collapsible:isMain});},equalizeTables:function(){var self=this;if(self.fixTable!=null&&self.varTable!=null){ccLib.equalizeHeights(self.fixTable.tHead,self.varTable.tHead);ccLib.equalizeHeights(self.fixTable.tBodies[0],self.varTable.tBodies[0]);}},featureValue:function(fId,data){var self=this;var feature=self.features[fId];if(feature.accumulate!==undefined)
return ccLib.getJsonValue(data,feature.accumulate)
else
return data.values[fId];},prepareTables:function(){var self=this;var varCols=[];var fixCols=[];var colList=fixCols;fixCols.push({"mData":"index","sClass":"middle","mRender":function(data,type,full){return(type!="display")?''+data:"&nbsp;-&nbsp;"+data+"&nbsp;-&nbsp;<br/>"+
'<span class="jtox-details-open ui-icon ui-icon-circle-triangle-s" title="Press to open/close detailed info for the entry"></span>';}},{"sClass":"jtox-hidden jtox-ds-details","mData":"index","mRender":function(data,type,full){return'';}});varCols.push({"sClass":"jtox-hidden jtox-ds-details","mData":"index","mRender":function(data,type,full){return'';}});var fnShowColumn=function(sel,idx){return function(){var cells=$(sel+' table tr>*:nth-child('+(idx+1)+')',self.rootElement);if(this.checked)
$(cells).show();else
$(cells).hide();self.equalizeTables();}};var fnExpandCell=function(cell,expand){var cnt=0;for(var c=cell;c;c=c.nextElementSibling,++cnt)
$(c).toggleClass('jtox-hidden');if(expand)
cell.setAttribute('colspan',''+cnt);else
cell.removeAttribute('colspan');};var fnShowDetails=function(row){var cell=$(".jtox-ds-details",row)[0];var idx=$(row).data('jtox-index');$(row).toggleClass('jtox-detailed-row');var toShow=$(row).hasClass('jtox-detailed-row');fnExpandCell(cell,toShow);var varCell=document.getElementById('jtox-var-'+self.instanceNo+'-'+idx).firstElementChild;fnExpandCell(varCell,toShow);if(toShow){var full=self.dataset.dataEntry[idx];var detDiv=document.createElement('div');varCell.appendChild(detDiv);self.prepareTabs(detDiv,false,function(id,name){if(cls.shortFeatureId(id)=="Diagram")
return null;var fEl=jToxKit.getTemplate('#jtox-one-detail');ccLib.fillTree(fEl,{title:name,value:self.featureValue(id,full)});return fEl;});var img=new Image();img.onload=function(e){self.equalizeTables();};img.src=full.compound.diagramUri;cell.appendChild(img);}
else{$(cell).empty();$(varCell).empty();self.equalizeTables();}};var checkList=$('.jtox-ds-features .jtox-checkbox',self.rootElement);var checkIdx=0;for(var gr in self.groups){for(var i=0,glen=self.groups[gr].length;i<glen;++i){var fId=self.groups[gr][i];var feature=self.features[fId];var col={"sTitle":feature.title+(ccLib.isNull(feature.units)?"":feature.units),"sDefaultContent":"-","mData":feature.accumulate!==undefined?feature.accumulate:"values."+fId};var shortId=cls.shortFeatureId(fId);if(shortId=="Diagram"){col["mRender"]=function(data,type,full){return(type!="display")?"-":'<img src="'+full.compound.diagramUri+'" class="jtox-ds-smalldiagram jtox-details-open"/>';};col["sClass"]="paddingless";col["sWidth"]="125px";}
else if(!!feature.shorten){col["mRender"]=function(data,type,full){return(type!="display")?''+data:jToxKit.shortenedDiv(data,"Press to copy the value in the clipboard");};}
$(checkList[checkIdx++]).on('change',fnShowColumn(colList==fixCols?'.jtox-ds-fixed':'.jtox-ds-variable',colList.length))
colList.push(col);}
colList=varCols;}
var fnQueryInfo=function(aoData){var info={};for(var i=0,dl=aoData.length;i<dl;++i)
info[aoData[i].name]=aoData[i].value;return info;};var fnSortDataset=function(info){var data=[];for(var i=0;i<info['iSortingCols'];++i)
data.push(info["mDataProp_"+info['iSortCol_'+i]]);if(data.length>0){self.dataset.dataEntry.sort(function(a,b){for(var i=0,dl=data.length;i<dl;++i){var val1=ccLib.getJsonValue(a,data[i]);var val2=ccLib.getJsonValue(b,data[i]);if(val1<val2)
return-1;else if(val1>val2)
return 1;}
return 0;});}};var fnSearchDataset=function(needle){};self.varTable=($(".jtox-ds-variable table",self.rootElement).dataTable({"bPaginate":false,"bProcessing":false,"bLengthChange":false,"bAutoWidth":true,"sDom":"rt","bSort":true,"aoColumns":varCols,"bScrollCollapse":true,"fnCreatedRow":function(nRow,aData,iDataIndex){nRow.id='jtox-var-'+self.instanceNo+'-'+iDataIndex;},"fnDrawCallback":function(oSettings){self.equalizeTables();}}))[0];self.fixTable=($(".jtox-ds-fixed table",self.rootElement).dataTable({"bPaginate":true,"bProcessing":true,"bLengthChange":false,"bAutoWidth":false,"sDom":"rt<Fip>","aoColumns":fixCols,"bSort":false,"fnDrawCallback":function(oSettings){self.equalizeTables();},"fnCreatedRow":function(nRow,aData,iDataIndex){$('.jtox-details-open',nRow).on('click',function(e){fnShowDetails(nRow);});$(nRow).data('jtox-index',iDataIndex);},"bServerSide":true,"fnServerData":function(sSource,aoData,fnCallback,oSettings){var info=fnQueryInfo(aoData);console.log("Server request with info = "+JSON.stringify(info));var page=info.iDisplayStart/info.iDisplayLength;var qUri=ccLib.addParameter(self.datasetUri,"page="+page+"&pagesize="+info.iDisplayLength);jToxKit.call(self,qUri,function(dataset){if(!!dataset){self.dataset=cls.processDataset(dataset,self.features,function(oldVal,newVal){if(ccLib.isNull(oldVal)||newVal.toLowerCase().indexOf(oldVal.toLowerCase())>=0)
return newVal;if(oldVal.toLowerCase().indexOf(newVal.toLowerCase())>=0)
return oldVal;return oldVal+", "+newVal;});$(self.varTable).dataTable().fnClearTable();$(self.varTable).dataTable().fnAddData(dataset.dataEntry);fnCallback({"sEcho":info.sEcho,"iTotalRecords":dataset.query.total,"iTotalDisplayRecords":dataset.dataEntry.length,"aaData":dataset.dataEntry});}});}}))[0];},prepareGroups:function(){var self=this;var grps=self.settings.groups;self.groups={};for(var i in grps){self.groups[i]=(grps[i])(i,self.features);}},clearDataset:function(){var self=this;},queryDataset:function(datasetUri){var self=this;self.clearDataset();self.datasetUri=datasetUri;jToxKit.call(self,datasetUri+'/feature',function(feature){if(!!feature){self.features=feature.feature;cls.processFeatures(self.features);self.prepareGroups();self.prepareTabs($('.jtox-ds-features',self.rootElement)[0],true,function(id,name){var fEl=jToxKit.getTemplate('#jtox-ds-feature');ccLib.fillTree(fEl,{title:name});$(fEl).data('feature-id',id);return fEl;});self.prepareTables();}});},};cls.shortFeatureId=function(fId){return fId.substr(fId.indexOf('#')+1);};cls.processEntry=function(entry,features,fnValue){for(var fid in entry.values){var feature=features[fid];if(feature.accumulate!==undefined){var accArr=feature.accumulate;if(!$.isArray(accArr))
accArr=[accArr];for(var v=0;v<accArr.length;++v){var oldVal=ccLib.getJsonValue(entry,accArr[v]);var newVal=entry.values[fid];if(typeof fnValue==="function")
ccLib.setJsonValue(entry,accArr[v],fnValue(oldVal,newVal));else if(!$.isArray(oldVal))
ccLib.setJsonValue(entry,accArr[v],ccLib.isNull(oldVal)?newVal:oldVal+newVal);else
oldVal.push(newVal);}}}
return entry;};cls.processFeatures=function(features){features=$.extend(features,baseFeatures);for(var fid in features){var feature=features[fid];var base=fid.replace(/(http.+\/feature\/).*/g,"$1");for(;;){if(feature.sameAs===undefined||feature.sameAs==null||feature.sameAs==fid||fid==base+feature.sameAs)
break;if(features[feature.sameAs]!==undefined)
feature=features[feature.sameAs];else{if(features[base+feature.sameAs]!==undefined)
feature=features[base+feature.sameAs];else
break;}}
features[fid]=$.extend(features[fid],feature);}
return features;};cls.processDataset=function(dataset,features,fnValue){if(ccLib.isNull(features)){cls.processFeatures(dataset.feature);features=dataset.feature;}
for(var i=0,dl=dataset.dataEntry.length;i<dl;++i){cls.processEntry(dataset.dataEntry[i],features,fnValue);dataset.dataEntry[i].index=i+1;var uri=dataset.dataEntry[i].compound.URI;uri=uri.replace(/(.+)(\/conformer.*)/,"$1");dataset.dataEntry[i].compound.diagramUri=uri+"?media=image/png";}
return dataset;};return cls;})();var jToxStudy=(function(){var defaultSettings={configuration:{columns:{}}};var instanceCount=0;var fnDatasetValue=function(old,value){return ccLib.extendArray(old,value!=null?value.trim().toLowerCase().split("|"):[value]).filter(ccNonEmptyFilter);};var cls=function(root,settings){var self=this;self.rootElement=root;self.suffix='_'+instanceCount++;self.settings=$.extend({},defaultSettings,jToxKit.settings,settings);if(!ccLib.isEmpty(self.settings.config)){jToxKit.call(self,self.settings.config,function(config){self.settings.configuration=$.extend(true,self.settings.configuration,config);});}
var tree=jToxKit.getTemplate('#jtox-studies');root.appendChild(tree);jToxKit.changeTabsIds(tree,self.suffix);var loadPanel=function(panel){if(panel){$('.jtox-study.unloaded',panel).each(function(i){var table=this;jToxKit.call(self,$(table).data('jtox-uri'),function(study){$(table).removeClass('unloaded folded');$(table).addClass('loaded');self.processStudies(panel,study.study,false);$('.dataTable',table).dataTable().fnAdjustColumnSizing();});});}};$(tree).tabs({"select":function(event,ui){loadPanel(ui.panel);},"beforeActivate":function(event,ui){if(ui.newPanel)
loadPanel(ui.newPanel[0]);}});if(self.settings['substanceUri']!==undefined){self.querySubstance(self.settings['substanceUri']);}};cls.prototype={getFormatted:function(data,type,format){var value=null;if(typeof format==='function')
value=format.call(this,data,type);else if(typeof format==='string'||typeof format==='number')
value=data[format];else
value=data[0];return value;},renderMulti:function(data,type,full,format){var self=this;var dlen=data.length;if(dlen<2)
return self.getFormatted(data[0],type,format);var height=100/dlen;var df='<table>';for(var i=0,dlen=data.length;i<dlen;++i){df+='<tr class="'+(i%2==0?'even':'odd')+'"><td class="center" style="height: '+height+'%">'+self.getFormatted(data[i],type,format)+'</td></tr>';}
df+='</table>';return df;},createCategory:function(tab,category){var self=this;var theCat=$('.'+category+'.jtox-study',tab)[0];if(!theCat){theCat=jToxKit.getTemplate('#jtox-study');tab.appendChild(theCat);$(theCat).addClass(category);$('.jtox-study-title',theCat).click(function(){$(theCat).toggleClass('folded');});}
return theCat;},updateCount:function(str,count){if(count===undefined)
count=0;return str.replace(/(.+)\s\(([0-9]+)\)/,"$1 ("+count+")");},ensureTable:function(tab,study){var self=this;var defaultColumns=[{"sTitle":"Name","sClass":"center middle","sWidth":"20%","mData":"protocol.endpoint"},{"sTitle":"Endpoint","sClass":"center middle jtox-multi","sWidth":"15%","mData":"effects","mRender":function(data,type,full){return self.renderMulti(data,type,full,"endpoint");}},{"sTitle":"Result","sClass":"center middle jtox-multi","sWidth":"15%","mData":"effects","mRender":function(data,type,full){return self.renderMulti(data,type,full,function(data,type){return formatLoHigh(data.result,type)})}},{"sTitle":"Guideline","sClass":"center middle","sWidth":"15%","mData":"protocol.guideline","mRender":"[,]","sDefaultContent":"?"},{"sTitle":"Owner","sClass":"center middle","sWidth":"50px","mData":"owner.company.name","mRender":function(data,type,full){return type!="display"?''+data:jToxKit.shortenedDiv(data);}},{"sTitle":"UUID","sClass":"center middle","sWidth":"50px","mData":"uuid","bSearchable":false,"mRender":function(data,type,full){return type!="display"?''+data:jToxKit.shortenedDiv(data,"Press to copy the UUID in the clipboard");}}]
var theTable=$('.'+study.protocol.category.code+' .jtox-study-table',tab)[0];if(!$(theTable).hasClass('dataTable')){var colDefs=[];var parCount=0;var modifyTitle=function(name,category){var newCol=self.settings.configuration.columns[name];if(ccLib.isNull(newCol))
return name;if(!ccLib.isNull(category))
newCol=newCol[category];if(ccLib.isNull(newCol))
return name;return!newCol.visible?null:(ccLib.isNull(newCol.name)?name:newCol.name);};var putAGroup=function(group,fProcess){var count=0;var skip=[];for(var p in group){if(skip.indexOf(p)>-1)
continue;if(group[p+" unit"]!==undefined)
skip.push(p+" unit");var val=fProcess(p);if(ccLib.isNull(val))
continue;colDefs.push(val);count++;}
return count;}
var putDefaults=function(start,len){for(var i=0;i<len;++i){var col=defaultColumns[i+start];col.sTitle=modifyTitle(col.sTitle);if(!ccLib.isNull(col.sTitle))
colDefs.push(col);}};var formatLoHigh=function(data,type){var out="";if(!ccLib.isNull(data)){data.loValue=ccLib.trim(data.loValue);data.upValue=ccLib.trim(data.upValue);if(!ccLib.isEmpty(data.loValue)&&!ccLib.isEmpty(data.upValue)){out+=(data.loQualifier==">=")?"[":"(";out+=data.loValue+", "+data.upValue;out+=(data.upQualifier=="<=")?"]":") ";}
else
{var fnFormat=function(q,v){return(!!q?q:"=")+" "+v;};if(!ccLib.isEmpty(data.loValue))
out+=fnFormat(data.loQualifier,data.loValue);else if(!ccLib.isEmpty(data.upValue))
out+=fnFormat(data.upQualifier,data.upValue);else
out+='-';}
out+=(data.unit=ccLib.trim(data.unit));}
return out.replace(/ /g,"&nbsp;");};var formatUnits=function(data,unit){data=ccLib.trim(data);unit=ccLib.trim(unit);return!ccLib.isNull(data)?(data+(!!unit?"&nbsp;"+unit:"")):"-";};putDefaults(0,1);parCount+=putAGroup(study.parameters,function(p){if(study.effects[0].conditions[p]!==undefined||study.effects[0].conditions[p+" unit"]!==undefined)
return undefined;var name=modifyTitle(p,"parameters");if(ccLib.isNull(name))
return null;var col={"sTitle":name,"sClass":"center middle","mData":"parameters."+p,"sDefaultContent":"-"};if(study.parameters[p]!==undefined&&study.parameters[p]!=null){col["mRender"]=study.parameters[p].loValue===undefined?function(data,type,full){return formatUnits(data,full[p+" unit"]);}:function(data,type,full){return formatLoHigh(data.parameters[p],type);};}
return col;});parCount+=putAGroup(study.effects[0].conditions,function(c){var rnFn=null;var name=modifyTitle(c,"conditions");if(ccLib.isNull(name))
return null;if(study.effects[0].conditions[c]!==undefined&&study.effects[0].conditions[c]!=null)
rnFn=study.effects[0].conditions[c].loValue===undefined?function(data,type){return formatUnits(data.conditions[c],data.conditions[c+" unit"]);}:function(data,type){return formatLoHigh(data.conditions[c],type);}
else
rnFn=function(data,type){return"-";}
return{"sTitle":name,"sClass":"center middle jtox-multi","mData":"effects","mRender":function(data,type,full){return self.renderMulti(data,type,full,rnFn);}};});putDefaults(1,2);parCount=putAGroup(study.interpretation,function(i){var name=modifyTitle(i,"interpretation");if(ccLib.isNull(name))
return null;return{"sTitle":name,"sClass":"center middle jtox-multi","mData":"interpretation."+i,"sDefaultContent":"-"};});putDefaults(3,3);$(theTable).dataTable({"bPaginate":true,"bProcessing":true,"bLengthChange":false,"bAutoWidth":false,"sDom":"rt<Fip>","aoColumns":colDefs,"fnInfoCallback":function(oSettings,iStart,iEnd,iMax,iTotal,sPre){var el=$('.jtox-study-title .data-field',$(this).parents('.jtox-study'))[0];el.innerHTML=self.updateCount(el.innerHTML,iTotal);return sPre;},"oLanguage":{"sProcessing":"<img src='"+self.baseUrl+"images/24x24_ambit.gif' border='0'>","sLoadingRecords":"No studies found.","sZeroRecords":"No studies found.","sEmptyTable":"No studies available.","sInfo":"Showing _TOTAL_ study(s) (_START_ to _END_)","sLengthMenu":'Display <select>'+
'<option value="10">10</option>'+
'<option value="20">20</option>'+
'<option value="50">50</option>'+
'<option value="100">100</option>'+
'<option value="-1">all</option>'+
'</select> studies.'}});}
else
$(theTable).dataTable().fnClearTable();return theTable;},processSummary:function(summary){var self=this;var typeSummary=[];var catList=self.rootElement.getElementsByClassName('jtox-study');while(catList.length>0){catList[0].parentNode.removeChild(catList[0]);}
for(var s in summary){var sum=summary[s];var top=sum.topcategory.title;if(!top)
continue;var top=top.replace(/ /g,"_");var tab=$('.jtox-study-tab.'+top,self.rootElement)[0];var catname=sum.category.title;if(!catname){typeSummary[top]=sum.count;}
else{var cat=self.createCategory(tab,catname);$(cat).data('jtox-uri',sum.category.uri);}}
$('ul li a',self.rootElement).each(function(i){var data=$(this).data('type');if(!!data){var cnt=typeSummary[data];var el=$(this)[0];el.innerHTML=(self.updateCount(el.innerHTML,cnt));}});var filterTimeout=null;var fFilter=function(ev){if(!!filterTimeout)
clearTimeout(filterTimeout);var field=ev.currentTarget;var tab=$(this).parents('.jtox-study-tab')[0];filterTimeout=setTimeout(function(){var tabList=tab.getElementsByClassName('jtox-study-table');for(var t=0,tlen=tabList.length;t<tlen;++t){$(tabList[t]).dataTable().fnFilter(field.value);}},300);};var tabList=document.getElementsByClassName('jtox-study-tab');for(var t=0,tlen=tabList.length;t<tlen;t++){var filterEl=tabList[t].getElementsByClassName('jtox-study-filter')[0].onkeydown=fFilter;}},processStudies:function(tab,study,map){var self=this;var cats=[];if(!map){cats[study[0].protocol.category.code]=study;}
else{for(var i=0,slen=study.length;i<slen;++i){var ones=study[i];if(map){if(cats[ones.protocol.category]===undefined){cats[ones.protocol.category.code]=[ones];}
else{cats[ones.protocol.category.code].push(ones);}}}}
for(var c in cats){var onec=cats[c];var aStudy=$('.'+c+'.jtox-study',tab)[0];if(aStudy===undefined)
continue;ccLib.fillTree(aStudy,{title:onec[0].protocol.category.title+" (0)"});var study={};for(var i=0,cl=onec.length;i<cl;++i){$.extend(true,study,onec[i]);if(!ccLib.isEmpty(study.parameters)&&!ccLib.isEmpty(study.effects[0].conditions))
break;}
var theTable=self.ensureTable(tab,study);$(theTable).dataTable().fnAddData(onec);$(theTable).colResizable();}
$('#'+theTable.id+' .jtox-multi').each(function(index){this.style.height=''+this.offsetHeight+'px';});},formatConcentration:function(precision,val,unit){return((precision===undefined||precision===null||"="==precision?"":precision)+val+" "+(unit==null||unit==''?"% (w/w)":unit)).replace(/ /g,"&nbsp;");},processComposition:function(json){var self=this;var tab=$('.jtox-composition',self.rootElement)[0];if($(tab).hasClass('unloaded')){$(tab).removeClass('unloaded');$(tab).empty();}
var prepareFillTable=function(json,panel){var theTable=$('.substances-table',panel);$(theTable).dataTable({"bSearchable":true,"bProcessing":true,"bPaginate":true,"sDom":"rt<Fip>","sPaginate":".dataTables_paginate _paging","bAutoWidth":false,"oLanguage":{"sProcessing":"<img src='"+self.baseUrl+"images/24x24_ambit.gif' border='0'>","sLoadingRecords":"No substances found.","sZeroRecords":"No substances found.","sEmptyTable":"No substances available.","sInfo":"Showing _TOTAL_ substance(s) (_START_ to _END_)",},"aoColumns":[{"sClass":"left","sWidth":"10%","mData":"relation","mRender":function(val,type,full){if(type!='display')
return''+val;var func=("HAS_ADDITIVE"==val)?full.proportion.function_as_additive:"";return'<span class="camelCase">'+val.replace("HAS_","").toLowerCase()+'</span>'+((func===undefined||func===null||func=='')?"":" ("+func+")");}},{"sClass":"camelCase left","sWidth":"15%","mData":"component.compound.name","mRender":function(val,type,full){return(type!='display')?''+val:'<a href="'+full.component.compound.URI+'" target="_blank" title="Click to view the compound"><span class="ui-icon ui-icon-link" style="float: left; margin-right: .3em;"></span></a>'+val;}},{"sClass":"left","sWidth":"10%","mData":"component.compound.einecs",},{"sClass":"left","sWidth":"10%","mData":"component.compound.cas",},{"sClass":"center","sWidth":"15%","mData":"proportion.typical","mRender":function(val,type,full){return type!='display'?''+val.value:self.formatConcentration(val.precision,val.value,val.unit);}},{"sClass":"center","sWidth":"15%","mData":"proportion.real","mRender":function(val,type,full){return type!='display'?''+val.lowerValue:self.formatConcentration(val.lowerPrecision,val.lowerValue,val.unit);}},{"sClass":"center","sWidth":"15%","mData":"proportion.real","mRender":function(val,type,full){return type!='display'?''+val.upperValue:self.formatConcentration(val.upperPrecision,val.upperValue,val.unit);}}]});$(theTable).dataTable().fnAddData(json);return theTable;};var substances={};jToxDataset.processFeatures(json.feature);for(var i=0,cmpl=json.composition.length;i<cmpl;++i){var cmp=json.composition[i];jToxDataset.processEntry(cmp.component,json.feature,fnDatasetValue);var theSubs=substances[cmp.compositionUUID];if(theSubs===undefined)
substances[cmp.compositionUUID]=theSubs={name:"",purity:"",maxvalue:0,uuid:cmp.compositionUUID,composition:[]};theSubs.composition.push(cmp);var val=cmp.proportion.typical;if(cmp.relation=='HAS_CONSTITUENT'&&(theSubs.maxvalue<val.value||theSubs.name=='')){theSubs.name=cmp.component.compound['name']+' '+self.formatConcentration(val.precision,val.value,val.unit);theSubs.maxvalue=val.value;val=cmp.proportion.real;theSubs.purity=(val.lowerValue+'-'+val.upperValue+' '+(val.unit==null||val.unit==''?"% (w/w)":val.unit)).replace(/ /g,"&nbsp;");}}
for(var i in substances){var panel=jToxKit.getTemplate('#jtox-compoblock');tab.appendChild(panel);ccLib.fillTree($('.composition-info',panel)[0],substances[i]);prepareFillTable(substances[i].composition,panel);}},querySummary:function(substanceURI){var self=this;jToxKit.call(self,substanceURI+"/studysummary",function(summary){if(!!summary&&!!summary.facet)
self.processSummary(summary.facet);});},queryComposition:function(substanceURI){var self=this;jToxKit.call(self,substanceURI+"/composition",function(composition){if(!!composition&&!!composition.composition)
self.processComposition(composition);});},querySubstance:function(substanceURI){var self=this;self.baseUrl=jToxKit.grabBaseUrl(substanceURI,'substance');var rootTab=$('.jtox-substance',self.rootElement)[0];jToxKit.call(self,substanceURI,function(substance){if(!!substance&&!!substance.substance&&substance.substance.length>0){substance=substance.substance[0];substance["showname"]=substance.publicname;if(ccLib.isEmpty(substance.showname))
substance.showname=substance.name;ccLib.fillTree(self.rootElement,substance);jToxKit.call(self,substance.referenceSubstance.uri,function(dataset){if(!!dataset){jToxDataset.processDataset(dataset,null,fnDatasetValue);ccLib.fillTree(rootTab,dataset.dataEntry[0]);}});self.querySummary(substance.URI);self.queryComposition(substance.URI);}});}};return cls;})();window.jToxKit={templateRoot:null,queries:{taskPoll:"/task/<1>",},templates:{},settings:{jsonp:false,baseUrl:null,timeout:15000,pollDelay:200,onConnect:function(s){},onSuccess:function(c,m){},onError:function(c,m){},},init:function(){var self=this;self.initTemplates();$(document).on('click','.jtox-toolkit span.ui-icon-copy',function(e){ccLib.copyToClipboard($(this).data('uuid'));return false;});var url=ccLib.parseURL(document.location);var queryParams=url.params;queryParams.host=url.host;self.settings=$.extend(self.settings,queryParams);if(!self.settings.baseUrl)
self.settings.baseUrl=self.settings.host;$('.jtox-toolkit').each(function(i){var dataParams=$(this).data();if(!dataParams.manualInit){if(dataParams.kit=="study")
new jToxStudy(this,dataParams);}});},initTemplates:function(){var self=this;var root=document.getElementsByClassName('jtox-template')[0];if(root===undefined){var html='';for(var t in self.templates){html+=self.templates[t];}
root=document.createElement('div');root.className='jtox-template';root.innerHTML=html;document.body.appendChild(root);}
self.templateRoot=root;},getTemplate:function(selector){var el=$(selector,this.templateRoot)[0];if(!!el){var el=$(selector,this.templateRoot)[0].cloneNode(true);el.removeAttribute('id');}
return el;},changeTabsIds:function(root,suffix){$('ul li a',root).each(function(){var id=$(this).attr('href').substr(1);var el=document.getElementById(id);id+=suffix;el.id=id;$(this).attr('href','#'+id);})},shortenedDiv:function(data,message,deflen){var res='';if(ccLib.isNull(deflen))
deflen=5;if(data.toString().length<=deflen){res+=data;}
else{res+='<div class="shortened">'+data+'</div>';if(message!=null)
res+='<span class="ui-icon ui-icon-copy" title="'+message+'" data-uuid="'+data+'"></span>';}
return res;},pollTask:function(task,callback){var self=this;if(task===undefined||task.task===undefined||task.task.length<1){ccLib.fireCallback(self.settings.onError,self,'-1',localMessage.taskFailed);return;}
task=task.task[0];if(task.completed==-1){setTimeout(function(){self.call(task.result,function(newTask){self.pollTask(newTask,callback);});},self.pollDelay);}
else if(!task.error){callback(task.result);}
else{ccLib.fireCallback(self.settings.onError,self,'-1',task.error);}},grabBaseUrl:function(url,main){if(url!==undefined&&url!=null&&url.indexOf('http')==0){var re=new RegExp("(.+\/)"+main+".*");return url.replace(re,"$1");}
else
return this.settings.baseUrl;},call:function(kit,service,callback,adata){if(kit==null)
kit=this;ccLib.fireCallback(kit.settings.onConnect,kit,service);var method='GET';var accType=kit.settings.jsonp?"application/x-javascript":"application/json";if(adata!==undefined){method='POST';if(typeof adata=="boolean")
adata={};}
else
adata={};if(service.indexOf("http")!=0)
service=(!!kit.settings.baseUrl?kit.settings.baseUrl:this.settings.baseUrl)+service;$.ajax(service,{dataType:kit.settings.jsonp?'jsonp':'json',headers:{Accept:accType},crossDomain:true,timeout:kit.settings.timeout,type:method,data:adata,jsonp:kit.settings.jsonp?'callback':false,error:function(jhr,status,error){ccLib.fireCallback(kit.settings.onError,kit,status,error);callback(null);},success:function(data,status,jhr){ccLib.fireCallback(kit.settings.onSuccess,kit,status,jhr.statusText);callback(data);}});}};$(document).ready(function(){jToxKit.init();});jToxKit.templates['all-dataset']="	  <div id=\"jtox-dataset\">"+
"	    <div class=\"jtox-ds-features\"></div>"+
"	    <div class=\"jtox-ds-tables\">"+
"	      <div class=\"jtox-ds-fixed\">"+
"	        <table></table>"+
"	      </div><div class=\"jtox-ds-variable\">"+
"	        <table></table>"+
"	      </div>"+
"	    </div>"+
"	  </div>"+
"";jToxKit.templates['dataset-one-feature']="    <div id=\"jtox-ds-feature\" class=\"jtox-ds-feature\"><input type=\"checkbox\" checked=\"yes\" class=\"jtox-checkbox\" /><span class=\"data-field jtox-title\" data-field=\"title\"> ? </span></div>"+
"";jToxKit.templates['dataset-export']="    <div id=\"jtox-ds-download\" class=\"jtox-inline jtox-ds-download\">"+
"      <a target=\"_blank\"><img class=\"borderless\"/></a>"+
"    </div>"+
"";jToxKit.templates['dataset-export']="    <div id=\"jtox-ds-export\">"+
"      <div class=\"jtox-inline\">Download dataset as: </div>"+
"      <div class=\"jtox-inline jtox-exportlist\"></div>"+
"    </div>"+
"";jToxKit.templates['dataset-details']="    <div id=\"jtox-one-detail\">"+
"      <span class=\"right data-field\" data-field=\"title\" style=\"width: 30%\"></span>"+
"      <span class=\"left data-field\" data-field=\"value\" style=\"width: 70%\"></span>"+
"    </div>"+
"";jToxKit.templates['all-studies']="	  <div id=\"jtox-studies\">"+
"	    <ul>"+
"	      <li><a href=\"#jtox-substance\">IUC Substance</a></li>"+
"	      <li><a href=\"#jtox-composition\">Composition</a></li>"+
"	      <li><a href=\"#jtox-pchem\" data-type=\"P-CHEM\">P-Chem (0)</a></li>"+
"	      <li><a href=\"#jtox-envfate\" data-type=\"ENV_FATE\">Env Fate (0)</a></li>"+
"	      <li><a href=\"#jtox-ecotox\" data-type=\"ECOTOX\">Eco Tox (0)</a></li>"+
"	      <li><a href=\"#jtox-tox\" data-type=\"TOX\">Tox (0)</a></li>"+
"	    </ul>"+
"	    <div id=\"jtox-substance\" class=\"jtox-substance\">"+
"	      <table class=\"dataTable\">"+
"	        <thead>"+
"	          <tr>"+
"	            <th class=\"right jtox-size-third\">IUC Substance name:</th>"+
"	            <td class=\"data-field camelCase\" data-field=\"name\"> ? </td>"+
"	          </tr>"+
"	          <tr>"+
"	            <th class=\"right\">IUC Substance UUID:</th>"+
"	            <td class=\"data-field\" data-field=\"i5uuid\"> ? </td>"+
"	          </tr>"+
"	          <tr>"+
"	            <th class=\"right\">IUC Public name:</th>"+
"	            <td class=\"data-field camelCase\" data-field=\"publicname\"> ? </td>"+
"	          </tr>"+
"	          <tr>"+
"	            <th class=\"right\">Legal entity:</th>"+
"	            <td class=\"data-field\" data-field=\"ownerName\"> ? </td>"+
"	          </tr>"+
"	          <tr>"+
"	            <th class=\"right\">Legal entity UUID:</th>"+
"	            <td class=\"data-field\" data-field=\"ownerUUID\"> ? </td>"+
"	          </tr>"+
"	          <tr>"+
"	            <th class=\"right\">Type substance composition:</th>"+
"	            <td class=\"data-field\" data-field=\"substanceType\"> ? </td>"+
"	          </tr>"+
"	          <tr class=\"borderless-bottom\">"+
"	            <th class=\"right\">IUC Substance Reference Identifier</th>"+
"	            <td></td>"+
"	          </tr>"+
"	          <tr class=\"borderless-top borderless-bottom\">"+
"	            <td class=\"right\">CAS:</td>"+
"	            <td class=\"data-field\" data-field=\"compound.cas\"> ? </td>"+
"	          </tr>"+
"	          <tr class=\"borderless-top borderless-bottom\">"+
"	            <td class=\"right\">EC:</td>"+
"	            <td class=\"data-field\" data-field=\"compound.einecs\"> ? </td>"+
"	          </tr>"+
"	          <tr class=\"borderless-top borderless-bottom\">"+
"	            <td class=\"right\">Chemical name:</td>"+
"	            <td class=\"data-field\" data-field=\"compound.name\"> ? </td>"+
"	          </tr>"+
"	          <tr class=\"borderless-top borderless-bottom\">"+
"	            <td class=\"right\">IUPAC name:</td>"+
"	            <td class=\"data-field\" data-field=\"compound.iupac\"> ? </td>"+
"	          </tr>"+
"	          <tr class=\"borderless-top borderless-bottom\">"+
"	            <td class=\"right\">UUID:</td>"+
"	            <td class=\"data-field\" data-field=\"referenceSubstance.i5uuid\"> ? </td>"+
"	          </tr>"+
"	          <tr class=\"borderless-top\">"+
"	            <td class=\"right\">IUC Subst. identifier used by Legal entity:</td>"+
"	            <td class=\"data-field\" data-field=\"compound.tradename\"> ? </td>"+
"	          </tr>"+
"	        </thead>"+
"	      </table>"+
"	    </div>"+
"	    <div id=\"jtox-composition\" class=\"jtox-composition unloaded\"></div>"+
"	    <div id=\"jtox-pchem\" class=\"jtox-study-tab P-CHEM\">"+
"	      <p><input type=\"text\" class=\"jtox-study-filter ui-input\" placeholder=\"Filter...\" /></p>"+
"	      <h4 class=\"data-field camelCase\" data-field=\"showname\"> ? </h4>"+
"      </div>"+
"	    <div id=\"jtox-envfate\" class=\"jtox-study-tab ENV_FATE\">"+
"	      <p><input type=\"text\" class=\"jtox-study-filter ui-input\" placeholder=\"Filter...\" /></p>"+
"	      <h4 class=\"data-field camelCase\" data-field=\"showname\"> ? </h4>"+
"	    </div>"+
"	    <div id=\"jtox-ecotox\" class=\"jtox-study-tab ECOTOX\">"+
"	      <p><input type=\"text\" class=\"jtox-study-filter ui-input\" placeholder=\"Filter...\" /></p>"+
"	      <h4 class=\"data-field camelCase\" data-field=\"showname\"> ? </h4>"+
"	    </div>"+
"	    <div id=\"jtox-tox\" class=\"jtox-study-tab TOX\">"+
"	      <p><input type=\"text\" class=\"jtox-study-filter ui-input\" placeholder=\"Filter...\" /></p>"+
"	      <h4 class=\"data-field camelCase\" data-field=\"showname\"> ? </h4>"+
"	    </div>"+
"	  </div>"+
"";jToxKit.templates['composition-block']="    <div id=\"jtox-compoblock\" class=\"jtox-compoblock\">"+
"      <table class=\"dataTable composition-info jtox-font-small\">"+
"        <thead>"+
"          <tr><th>Composition name:</th><td class=\"data-field camelCase\" data-field=\"name\"> ? </td></tr>"+
"          <tr><th>Composition UUID:</th><td class=\"data-field\" data-field=\"uuid\"> ? </td></tr>"+
"          <tr><th>Purity of IUC Substance:</th><td class=\"data-field\" data-field=\"purity\"> ? </td></tr>"+
"        </thead>"+
"      </table>"+
"      <table class=\"substances-table\">"+
"        <thead>"+
"          <tr>"+
"            <th>Type</th>"+
"            <th>Name</th>"+
"            <th>EC No.</th>"+
"            <th>CAS No.</th>"+
"            <th>Typical concentration</th>"+
"            <th colspan=\"2\">Concentration ranges</th>"+
"          </tr>"+
"        </thead>"+
"      </table>"+
"    </div>"+
"";jToxKit.templates['one-study']="    <div id=\"jtox-study\" class=\"jtox-study jtox-foldable folded unloaded\">"+
"      <div class=\"jtox-study-title\"><p class=\"data-field\" data-field=\"title\">? (0)</p></div>"+
"      <table class=\"jtox-study-table\"></table>"+
"    </div>"+
"";